<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airflow DAG Flow Chart</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
        }
        .legend {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .legend-box {
            width: 30px;
            height: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Airflow DAG Orchestration Flow</h1>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-box" style="background: #2196f3; border: 2px solid #0d47a1;"></div>
                <span>Repository DAGs</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: #4caf50; border: 2px solid #1b5e20;"></div>
                <span>DBT Model DAGs</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: #ff9800; border: 2px solid #e65100;"></div>
                <span>Client Stats DAGs</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: #9c27b0; border: 2px solid #4a148c;"></div>
                <span>Task Groups</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: #f44336; border: 2px solid #b71c1c;"></div>
                <span>Cleanup Tasks</span>
            </div>
        </div>

        <svg width="1520" height="2400" viewBox="0 0 1520 2400" xmlns="http://www.w3.org/2000/svg">
            <!-- Title -->
            <text x="760" y="30" text-anchor="middle" font-size="24" font-weight="bold" fill="#333">Data Warehouse Airflow DAGs</text>
            
            <!-- Main DAG Flow -->
            <g id="main-flow">
                <!-- Clone Repo DAG -->
                <g id="clone-repo-dag" transform="translate(50, 80)">
                    <rect x="0" y="0" width="1420" height="400" rx="10" fill="#e1f5fe" stroke="#0277bd" stroke-width="2"/>
                    <text x="710" y="30" text-anchor="middle" font-size="18" font-weight="bold" fill="#0277bd">Clone Repository DAGs (Scheduled: Daily 8 AM ET)</text>
                    
                    <!-- Clone Tasks -->
                    <rect x="50" y="60" width="200" height="60" rx="6" fill="#2196f3" stroke="#0d47a1" stroke-width="2"/>
                    <text x="150" y="85" text-anchor="middle" font-size="12" fill="white" font-weight="bold">clone_repo</text>
                    <text x="150" y="105" text-anchor="middle" font-size="10" fill="white">Clone GitHub repo</text>
                    
                    <path d="M 250 90 L 300 90" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <rect x="300" y="60" width="200" height="60" rx="6" fill="#2196f3" stroke="#0d47a1" stroke-width="2"/>
                    <text x="400" y="85" text-anchor="middle" font-size="12" fill="white" font-weight="bold">save_service_json</text>
                    <text x="400" y="105" text-anchor="middle" font-size="10" fill="white">Get service account</text>
                    
                    <path d="M 500 90 L 550 90" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <rect x="550" y="60" width="200" height="60" rx="6" fill="#2196f3" stroke="#0d47a1" stroke-width="2"/>
                    <text x="650" y="85" text-anchor="middle" font-size="12" fill="white" font-weight="bold">verify_repo</text>
                    <text x="650" y="105" text-anchor="middle" font-size="10" fill="white">Verify repo structure</text>
                    
                    <path d="M 750 90 L 800 90" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <rect x="800" y="60" width="200" height="60" rx="6" fill="#ff5722" stroke="#bf360c" stroke-width="2"/>
                    <text x="900" y="85" text-anchor="middle" font-size="12" fill="white" font-weight="bold">trigger_run_dbt</text>
                    <text x="900" y="105" text-anchor="middle" font-size="10" fill="white">Trigger silver_models</text>
                    
                    <!-- Details Box -->
                    <rect x="50" y="150" width="600" height="200" rx="6" fill="white" stroke="#0277bd" stroke-width="1"/>
                    <text x="60" y="170" font-size="12" font-weight="bold" fill="#333">Clone Repository Details:</text>
                    <text x="60" y="190" font-size="10" fill="#666">• Retrieves SSH key from Google Secret Manager</text>
                    <text x="60" y="205" font-size="10" fill="#666">• Clones ps_silver_gold repository from GitHub</text>
                    <text x="60" y="220" font-size="10" fill="#666">• Dev: checks out 'dev' branch → /home/airflow/gcs/data/dev_ps_repo</text>
                    <text x="60" y="235" font-size="10" fill="#666">• Prod: checks out 'main' branch → /home/airflow/gcs/data/ps_repo</text>
                    <text x="60" y="250" font-size="10" fill="#666">• Saves service account JSON from Secret Manager</text>
                    <text x="60" y="265" font-size="10" fill="#666">• Verifies repository content and structure</text>
                    <text x="60" y="280" font-size="10" fill="#666">• Triggers downstream silver_models DAG</text>
                    <text x="60" y="310" font-size="12" font-weight="bold" fill="#333">Schedule: Daily at 8:00 AM ET</text>
                    <text x="60" y="330" font-size="10" fill="#666">• Retries: 3 times with 2-minute delay</text>
                    
                    <!-- Environment Badge -->
                    <rect x="1050" y="60" width="120" height="40" rx="20" fill="#1976d2" stroke="#0d47a1" stroke-width="2"/>
                    <text x="1110" y="85" text-anchor="middle" font-size="12" fill="white" font-weight="bold">dev/prod</text>
                </g>
                
                <!-- Arrow between DAGs -->
                <path d="M 760 480 L 760 540" stroke="#666" stroke-width="3" marker-end="url(#arrowhead-large)"/>
                <text x="780" y="515" font-size="12" fill="#666">Triggers</text>
                
                <!-- Silver Models DAG -->
                <g id="silver-models-dag" transform="translate(50, 540)">
                    <rect x="0" y="0" width="1420" height="800" rx="10" fill="#e8f5e9" stroke="#2e7d32" stroke-width="2"/>
                    <text x="710" y="30" text-anchor="middle" font-size="18" font-weight="bold" fill="#2e7d32">DBT Silver Models DAG (Triggered by Clone Repo)</text>
                    
                    <!-- Check Repo -->
                    <rect x="560" y="60" width="200" height="60" rx="6" fill="#4caf50" stroke="#1b5e20" stroke-width="2"/>
                    <text x="660" y="85" text-anchor="middle" font-size="12" fill="white" font-weight="bold">check_repo_exists</text>
                    <text x="660" y="105" text-anchor="middle" font-size="10" fill="white">Verify repo path</text>
                    
                    <path d="M 660 120 L 660 160" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- Platform Task Groups -->
                    <g id="task-groups" transform="translate(0, 160)">
                        <!-- Staging Layer -->
                        <rect x="50" y="0" width="1320" height="200" rx="8" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="2" stroke-dasharray="5,5"/>
                        <text x="710" y="25" text-anchor="middle" font-size="14" font-weight="bold" fill="#7b1fa2">Layer: staging</text>
                        
                        <!-- Platform Tasks -->
                        <rect x="80" y="40" width="150" height="50" rx="6" fill="#9c27b0" stroke="#4a148c" stroke-width="2"/>
                        <text x="155" y="60" text-anchor="middle" font-size="11" fill="white" font-weight="bold">google_staging</text>
                        <text x="155" y="75" text-anchor="middle" font-size="9" fill="white">google.staging</text>
                        
                        <rect x="250" y="40" width="150" height="50" rx="6" fill="#9c27b0" stroke="#4a148c" stroke-width="2"/>
                        <text x="325" y="60" text-anchor="middle" font-size="11" fill="white" font-weight="bold">facebook_staging</text>
                        <text x="325" y="75" text-anchor="middle" font-size="9" fill="white">facebook.staging</text>
                        
                        <rect x="420" y="40" width="150" height="50" rx="6" fill="#9c27b0" stroke="#4a148c" stroke-width="2"/>
                        <text x="495" y="60" text-anchor="middle" font-size="11" fill="white" font-weight="bold">linkedin_staging</text>
                        <text x="495" y="75" text-anchor="middle" font-size="9" fill="white">linkedin.staging</text>
                        
                        <rect x="590" y="40" width="150" height="50" rx="6" fill="#9c27b0" stroke="#4a148c" stroke-width="2"/>
                        <text x="665" y="60" text-anchor="middle" font-size="11" fill="white" font-weight="bold">pinterest_staging</text>
                        <text x="665" y="75" text-anchor="middle" font-size="9" fill="white">pinterest.staging</text>
                        
                        <rect x="760" y="40" width="150" height="50" rx="6" fill="#9c27b0" stroke="#4a148c" stroke-width="2"/>
                        <text x="835" y="60" text-anchor="middle" font-size="11" fill="white" font-weight="bold">bing_staging</text>
                        <text x="835" y="75" text-anchor="middle" font-size="9" fill="white">bing.staging</text>
                        
                        <rect x="930" y="40" width="150" height="50" rx="6" fill="#9c27b0" stroke="#4a148c" stroke-width="2"/>
                        <text x="1005" y="60" text-anchor="middle" font-size="11" fill="white" font-weight="bold">tiktok_staging</text>
                        <text x="1005" y="75" text-anchor="middle" font-size="9" fill="white">tiktok.staging</text>
                        
                        <rect x="1100" y="40" width="150" height="50" rx="6" fill="#9c27b0" stroke="#4a148c" stroke-width="2"/>
                        <text x="1175" y="60" text-anchor="middle" font-size="11" fill="white" font-weight="bold">stackadapt_staging</text>
                        <text x="1175" y="75" text-anchor="middle" font-size="9" fill="white">stackadapt.staging</text>
                        
                        <!-- Facebook Note -->
                        <rect x="250" y="110" width="150" height="60" rx="6" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="1"/>
                        <text x="325" y="130" text-anchor="middle" font-size="9" fill="#7b1fa2" font-weight="bold">Facebook Layers:</text>
                        <text x="325" y="145" text-anchor="middle" font-size="8" fill="#7b1fa2">• staging</text>
                        <text x="325" y="155" text-anchor="middle" font-size="8" fill="#7b1fa2">• connecting</text>
                        <text x="325" y="165" text-anchor="middle" font-size="8" fill="#7b1fa2">• intermediate</text>
                    </g>
                    
                    <path d="M 660 360 L 660 400" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- Intermediate Layer -->
                    <g id="intermediate-layer" transform="translate(0, 400)">
                        <rect x="50" y="0" width="1320" height="120" rx="8" fill="#e8f5e9" stroke="#388e3c" stroke-width="2" stroke-dasharray="5,5"/>
                        <text x="710" y="25" text-anchor="middle" font-size="14" font-weight="bold" fill="#388e3c">Layer: intermediate</text>
                        
                        <text x="710" y="60" text-anchor="middle" font-size="11" fill="#666">All platforms run intermediate models</text>
                        <text x="710" y="80" text-anchor="middle" font-size="10" fill="#666">(platform__account_report, platform__campaign_report, etc.)</text>
                        <text x="710" y="100" text-anchor="middle" font-size="10" fill="#666">Models join staging tables and add business logic</text>
                    </g>
                    
                    <path d="M 660 520 L 660 560" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- Trigger Client Stats -->
                    <rect x="510" y="560" width="300" height="60" rx="6" fill="#ff5722" stroke="#bf360c" stroke-width="2"/>
                    <text x="660" y="585" text-anchor="middle" font-size="12" fill="white" font-weight="bold">trigger_client_stats</text>
                    <text x="660" y="605" text-anchor="middle" font-size="10" fill="white">wait_for_completion=True</text>
                    
                    <path d="M 660 620 L 660 660" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- Cleanup -->
                    <rect x="510" y="660" width="300" height="60" rx="6" fill="#f44336" stroke="#b71c1c" stroke-width="2"/>
                    <text x="660" y="685" text-anchor="middle" font-size="12" fill="white" font-weight="bold">cleanup_service_account</text>
                    <text x="660" y="705" text-anchor="middle" font-size="10" fill="white">Remove service-account.json</text>
                    
                    <!-- Config Box -->
                    <rect x="50" y="740" width="400" height="40" rx="6" fill="white" stroke="#2e7d32" stroke-width="1"/>
                    <text x="60" y="760" font-size="10" fill="#666">Config: platforms, layers from Airflow Variables</text>
                    <text x="60" y="775" font-size="10" fill="#666">Optional: full_refresh, dbt_table_names overrides</text>
                </g>
                
                <!-- Arrow to Client Stats -->
                <path d="M 760 1340 L 760 1400" stroke="#666" stroke-width="3" marker-end="url(#arrowhead-large)"/>
                <text x="780" y="1375" font-size="12" fill="#666">Triggers & Waits</text>
                
                <!-- Client Stats DAG -->
                <g id="client-stats-dag" transform="translate(50, 1400)">
                    <rect x="0" y="0" width="1420" height="600" rx="10" fill="#fff3e0" stroke="#f57c00" stroke-width="2"/>
                    <text x="710" y="30" text-anchor="middle" font-size="18" font-weight="bold" fill="#f57c00">Client Stats DAG (Triggered by Silver Models)</text>
                    
                    <!-- Run Mart Models -->
                    <rect x="510" y="60" width="300" height="60" rx="6" fill="#ff9800" stroke="#e65100" stroke-width="2"/>
                    <text x="660" y="85" text-anchor="middle" font-size="12" fill="white" font-weight="bold">run_mart_models</text>
                    <text x="660" y="105" text-anchor="middle" font-size="10" fill="white">dbt run -m models/mart --full-refresh</text>
                    
                    <path d="M 660 120 L 660 160" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                    
                    <!-- Client Table Scripts -->
                    <g id="client-scripts" transform="translate(0, 160)">
                        <text x="710" y="0" text-anchor="middle" font-size="14" font-weight="bold" fill="#f57c00">Sequential Client Table Creation</text>
                        
                        <rect x="80" y="20" width="200" height="50" rx="6" fill="#ff9800" stroke="#e65100" stroke-width="2"/>
                        <text x="180" y="40" text-anchor="middle" font-size="11" fill="white" font-weight="bold">account_stats_client</text>
                        <text x="180" y="55" text-anchor="middle" font-size="9" fill="white">Create account tables</text>
                        
                        <path d="M 280 45 L 330 45" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <rect x="330" y="20" width="200" height="50" rx="6" fill="#ff9800" stroke="#e65100" stroke-width="2"/>
                        <text x="430" y="40" text-anchor="middle" font-size="11" fill="white" font-weight="bold">ad_group_stats_client</text>
                        <text x="430" y="55" text-anchor="middle" font-size="9" fill="white">Create ad group tables</text>
                        
                        <path d="M 530 45 L 580 45" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <rect x="580" y="20" width="200" height="50" rx="6" fill="#ff9800" stroke="#e65100" stroke-width="2"/>
                        <text x="680" y="40" text-anchor="middle" font-size="11" fill="white" font-weight="bold">ad_stats_client</text>
                        <text x="680" y="55" text-anchor="middle" font-size="9" fill="white">Create ad tables</text>
                        
                        <path d="M 780 45 L 830 45" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <rect x="830" y="20" width="200" height="50" rx="6" fill="#ff9800" stroke="#e65100" stroke-width="2"/>
                        <text x="930" y="40" text-anchor="middle" font-size="11" fill="white" font-weight="bold">campaign_stats_client</text>
                        <text x="930" y="55" text-anchor="middle" font-size="9" fill="white">Create campaign tables</text>
                        
                        <path d="M 1030 45 L 1080 45" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <rect x="1080" y="20" width="200" height="50" rx="6" fill="#ff9800" stroke="#e65100" stroke-width="2"/>
                        <text x="1180" y="40" text-anchor="middle" font-size="11" fill="white" font-weight="bold">device_stats_client</text>
                        <text x="1180" y="55" text-anchor="middle" font-size="9" fill="white">Create device tables</text>
                        
                        <!-- Second Row -->
                        <path d="M 1180 70 L 1180 90 L 180 90 L 180 110" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <rect x="80" y="110" width="200" height="50" rx="6" fill="#ff9800" stroke="#e65100" stroke-width="2"/>
                        <text x="180" y="130" text-anchor="middle" font-size="11" fill="white" font-weight="bold">geo_stats_client</text>
                        <text x="180" y="145" text-anchor="middle" font-size="9" fill="white">Create geo tables</text>
                        
                        <path d="M 280 135 L 330 135" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <rect x="330" y="110" width="200" height="50" rx="6" fill="#ff9800" stroke="#e65100" stroke-width="2"/>
                        <text x="430" y="130" text-anchor="middle" font-size="11" fill="white" font-weight="bold">keyword_stats_client</text>
                        <text x="430" y="145" text-anchor="middle" font-size="9" fill="white">Create keyword tables</text>
                        
                        <path d="M 530 135 L 580 135" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                        
                        <rect x="580" y="110" width="200" height="50" rx="6" fill="#f44336" stroke="#b71c1c" stroke-width="2"/>
                        <text x="680" y="130" text-anchor="middle" font-size="11" fill="white" font-weight="bold">cleanup_service_json</text>
                        <text x="680" y="145" text-anchor="middle" font-size="9" fill="white">Final cleanup</text>
                    </g>
                    
                    <!-- Python Script Details -->
                    <rect x="50" y="380" width="600" height="180" rx="6" fill="white" stroke="#f57c00" stroke-width="1"/>
                    <text x="60" y="400" font-size="12" font-weight="bold" fill="#333">Client Table Script Process:</text>
                    <text x="60" y="420" font-size="10" fill="#666">1. Read unified mart table (e.g., account_unified_stats)</text>
                    <text x="60" y="435" font-size="10" fill="#666">2. Get unique client_ids from the data</text>
                    <text x="60" y="450" font-size="10" fill="#666">3. For each client_id:</text>
                    <text x="80" y="465" font-size="10" fill="#666">• Filter data for that client</text>
                    <text x="80" y="480" font-size="10" fill="#666">• Create table: [performance_schema].[client_id]_[report_type]</text>
                    <text x="80" y="495" font-size="10" fill="#666">• Example: account_performance.ABC123_account_report</text>
                    <text x="60" y="520" font-size="10" fill="#666">4. Log success/failure for each client</text>
                    <text x="60" y="535" font-size="10" fill="#666">5. Clean up service account file after all scripts complete</text>
                    
                    <!-- Output Example -->
                    <rect x="700" y="380" width="670" height="180" rx="6" fill="#fff8e1" stroke="#ffa000" stroke-width="1"/>
                    <text x="710" y="400" font-size="12" font-weight="bold" fill="#333">Output Tables Example:</text>
                    <text x="710" y="420" font-size="10" fill="#666">For client_id 'ABC123':</text>
                    <text x="730" y="440" font-size="9" font-family="monospace" fill="#666">account_performance.ABC123_account_report</text>
                    <text x="730" y="455" font-size="9" font-family="monospace" fill="#666">campaign_performance.ABC123_campaign_report</text>
                    <text x="730" y="470" font-size="9" font-family="monospace" fill="#666">ad_group_performance.ABC123_ad_group_report</text>
                    <text x="730" y="485" font-size="9" font-family="monospace" fill="#666">ad_performance.ABC123_ad_report</text>
                    <text x="730" y="500" font-size="9" font-family="monospace" fill="#666">keyword_performance.ABC123_keyword_report</text>
                    <text x="730" y="515" font-size="9" font-family="monospace" fill="#666">geo_performance.ABC123_geo_report</text>
                    <text x="730" y="530" font-size="9" font-family="monospace" fill="#666">device_performance.ABC123_device_report</text>
                </g>
                
                <!-- Summary Box -->
                <g id="summary" transform="translate(50, 2050)">
                    <rect x="0" y="0" width="1420" height="300" rx="10" fill="#f5f5f5" stroke="#666" stroke-width="1"/>
                    <text x="710" y="30" text-anchor="middle" font-size="18" font-weight="bold" fill="#333">Complete DAG Execution Flow</text>
                    
                    <text x="50" y="70" font-size="12" font-weight="bold" fill="#333">Daily Schedule (8 AM ET):</text>
                    <text x="50" y="90" font-size="11" fill="#666">1. Clone Repository DAG starts automatically</text>
                    <text x="50" y="110" font-size="11" fill="#666">2. Silver Models DAG triggered after repo is ready</text>
                    <text x="50" y="130" font-size="11" fill="#666">3. Client Stats DAG triggered after silver models complete</text>
                    <text x="50" y="150" font-size="11" fill="#666">4. All client tables created sequentially</text>
                    <text x="50" y="170" font-size="11" fill="#666">5. Service account files cleaned up</text>
                    
                    <text x="50" y="210" font-size="12" font-weight="bold" fill="#333">Key Features:</text>
                    <text x="50" y="230" font-size="11" fill="#666">• Parallel execution within layers (staging/intermediate)</text>
                    <text x="50" y="250" font-size="11" fill="#666">• Sequential dependencies between layers</text>
                    <text x="50" y="270" font-size="11" fill="#666">• Automatic cleanup of sensitive files</text>
                    
                    <text x="750" y="70" font-size="12" font-weight="bold" fill="#333">Airflow Variables Used:</text>
                    <text x="750" y="90" font-size="11" fill="#666">• platforms: ["google", "facebook", "linkedin", ...]</text>
                    <text x="750" y="110" font-size="11" fill="#666">• default_layers: ["staging", "intermediate"]</text>
                    <text x="750" y="130" font-size="11" fill="#666">• facebook_layers: ["staging", "connecting", "intermediate"]</text>
                    <text x="750" y="150" font-size="11" fill="#666">• full_refresh: true/false</text>
                    <text x="750" y="170" font-size="11" fill="#666">• dbt_table_